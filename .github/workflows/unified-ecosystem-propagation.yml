name: Unified Ecosystem Propagation
on:
  workflow_dispatch:
    inputs:
      target_repos:
        description: 'Comma-separated list of repos (leave empty for all)'
        required: false
        default: ''
  schedule:
    - cron: '0 2 * * 0'  # Weekly Sunday 2 AM UTC

jobs:
  audit-and-propagate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout omnigrid
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install PyGithub
      
      - name: Audit Repository Existence
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Auditing repository existence..."
          python3 scripts/audit_repo_existence.py \
            --config config/ecosystem-repos.json \
            --output audit/repo-existence-check.json
      
      - name: Check CodeNest Connection Status
        run: |
          echo "ðŸ”— Checking CodeNest connections..."
          python3 scripts/check_codenest_connection.py \
            --config config/ecosystem-repos.json \
            --audit-file audit/repo-existence-check.json \
            --output audit/codenest-connection-status.json
      
      - name: Propagate to Verified Repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¤ Propagating to verified repositories..."
          
          # Check if we should run in production mode
          if [ -n "${{ secrets.ECOSYSTEM_SYNC_TOKEN }}" ]; then
            echo "ðŸš€ Running in PRODUCTION mode"
            export GITHUB_TOKEN="${{ secrets.ECOSYSTEM_SYNC_TOKEN }}"
            python3 scripts/ecosystem_propagator.py \
              --config config/ecosystem-repos.json
          else
            echo "ðŸ§ª Running in DRY RUN mode (ECOSYSTEM_SYNC_TOKEN not set)"
            python3 scripts/ecosystem_propagator.py \
              --config config/ecosystem-repos.json \
              --dry-run
          fi
      
      - name: Generate Summary Report
        if: always()
        run: |
          echo "ðŸ“Š Generating summary report..."
          
          cat > audit/PROPAGATION_SUMMARY.md << 'EOF'
          # Ecosystem Propagation Summary
          
          **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Trigger:** ${{ github.event_name }}
          
          ## Audit Results
          
          ### Repository Existence
          - See: `audit/repo-existence-check.json`
          
          ### CodeNest Connections
          - See: `audit/codenest-connection-status.json`
          
          ### Propagation Results
          - See: `ecosystem_propagation_report.json`
          
          ## Next Steps
          
          1. Review disconnected repositories in `audit/codenest-connection-status.json`
          2. Follow integration roadmap in `docs/CODENEST-INTEGRATION-ROADMAP.md`
          3. Update `config/ecosystem-repos.json` to remove non-existent repos
          
          ---
          
          *Unified Ecosystem Propagation v1.0 | OmniGrid Automation*
          EOF
          
          echo "âœ… Summary report generated"
      
      - name: Upload Audit Results
        uses: actions/upload-artifact@v4
        with:
          name: ecosystem-audit-results-${{ github.run_number }}
          path: |
            audit/
            ecosystem_propagation_report.json
          retention-days: 90
      
      - name: Commit Audit Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Ecosystem Audit Bot"
          
          # Add audit results
          git add -f audit/
          
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || \
            git commit -m "ðŸ“Š Ecosystem audit: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" && \
            git push
      
      - name: Post Summary Comment
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read audit results
            let auditSummary = '## ðŸ” Ecosystem Audit Complete\n\n';
            
            try {
              const repoCheck = JSON.parse(fs.readFileSync('audit/repo-existence-check.json', 'utf8'));
              auditSummary += `### Repository Existence\n`;
              auditSummary += `- Total listed: ${repoCheck.repos_listed_in_config}\n`;
              auditSummary += `- Verified exist: ${repoCheck.repos_verified_exist}\n`;
              auditSummary += `- Not found: ${repoCheck.repos_not_found.length}\n`;
              auditSummary += `- Private/No access: ${repoCheck.repos_private_no_access.length}\n\n`;
            } catch (e) {
              auditSummary += 'âš ï¸ Could not read repository audit results\n\n';
            }
            
            try {
              const connectionCheck = JSON.parse(fs.readFileSync('audit/codenest-connection-status.json', 'utf8'));
              auditSummary += `### CodeNest Connections\n`;
              auditSummary += `- Total in CodeNest: ${connectionCheck.total_repos_in_codenest}\n`;
              auditSummary += `- Connected: ${connectionCheck.connected_repos.length}\n`;
              auditSummary += `- Disconnected: ${connectionCheck.disconnected_repos.length}\n\n`;
            } catch (e) {
              auditSummary += 'âš ï¸ Could not read connection status\n\n';
            }
            
            auditSummary += '### ðŸ“¦ Artifacts\n';
            auditSummary += `- [View Audit Results](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            
            console.log(auditSummary);
